<!DOCTYPE html>
<html>
  <head>
      <script>
  var _hmt = _hmt || []
  ;(function() {
    var hm = document.createElement('script')
    hm.src = 'https://hm.baidu.com/hm.js?5a0acc897fd96474a2c8f4deac84611a'
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(hm, s)
  })()
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="Mino,前端,后端,全栈,NodeJs,JavaScript" />
    <meta name="description" content="Mino&#39;s personal blog" />
    
    <title>
      mongoose操作 - Mino
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/style/style.css">
  <link rel="alternate" href="/atom.xml" title="Mino" type="application/atom+xml">
</head>
  <body>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#引入"><span class="toc-text">引入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo1"><span class="toc-text">Demo1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo2"><span class="toc-text">Demo2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义模式"><span class="toc-text">定义模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据模式获取模型"><span class="toc-text">根据模式获取模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo1-1"><span class="toc-text">Demo1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#增加"><span class="toc-text">增加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改"><span class="toc-text">修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除"><span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查找"><span class="toc-text">查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取符合条件的文档的数量"><span class="toc-text">获取符合条件的文档的数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修饰符-数据验证"><span class="toc-text">修饰符/数据验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作符"><span class="toc-text">操作符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#聚合管道-高级查询"><span class="toc-text">聚合管道(高级查询)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#project"><span class="toc-text">$project</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match"><span class="toc-text">$match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#group"><span class="toc-text">$group</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#limit"><span class="toc-text">$limit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#skip"><span class="toc-text">$skip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lookup"><span class="toc-text">$lookup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sort"><span class="toc-text">$sort</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分页"><span class="toc-text">分页</span></a></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.jpg" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          首页
        </a>
        
        <a href="/about" class="">
          关于
        </a>
        
        <a href="/tags" class="">
          标签
        </a>
        
        <a href="/categories" class="">
          分类
        </a>
        
        <a href="/archives" class="">
          归档
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        <div class="author">Mino</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">Mino</div>
          <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            首页
          </a>
          
          <a href="/about" class="">
            关于
          </a>
          
          <a href="/tags" class="">
            标签
          </a>
          
          <a href="/categories" class="">
            分类
          </a>
          
          <a href="/archives" class="">
            归档
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/codermino" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="1227657064@qq.com" target="_block">
              <span class="iconfont icon-QQ"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">mongoose操作</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2020/08/19</span>
        </span>

        

         
        <span class="item">
          <span class="iconfont icon-folder"></span>
          <span>
              
                
                  <a href="/categories/mongodb">mongodb</a>
                
              
          </span>
        </span>
        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/mongoose操作">mongoose操作</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <p><a href="data:image/png;base64,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" target="_blank" rel="noopener" data-caption="mongoose" data-fancybox="images"><img src="data:image/png;base64,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" alt="mongoose"></a></p>
<p><strong>mongoose是一个在Node中方便操作mongodb数据库的工具。主要形式是以对象</strong><br><strong>安装</strong>：npm install mongoose –save</p>
<h3 id="引入">引入<a class="post-anchor" href="#引入"></a></h3><h4 id="Demo1">Demo1<a class="post-anchor" href="#Demo1"></a></h4><pre><code class="hljs js"><span class="hljs-comment">//  连接数据库</span>
<span class="hljs-keyword">const</span> mongoose =<span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
mongoose.connect(<span class="hljs-string">'mongodb://localhost/2020'</span>,&#123; <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">useCreateIndex</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">useFindAndModify</span>:<span class="hljs-literal">false</span> &#125;);
<span class="hljs-comment">//连接数据库</span>
<span class="hljs-keyword">const</span> db = mongoose.connection;<span class="hljs-comment">//数据库的连接对象</span>

db.on(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">console</span>.error.bind(<span class="hljs-built_in">console</span>, <span class="hljs-string">'connection error:'</span>));

db.once(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'db ok'</span>)
&#125;);</code></pre>
<h4 id="Demo2">Demo2<a class="post-anchor" href="#Demo2"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 本例以《连接本地名为myDB的数据库》为例</span>

<span class="hljs-comment">// 1.无账号密码：</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);<span class="hljs-comment">// 引入mongoose模块</span>
<span class="hljs-comment">// 连接mongodb。填入mongodb所在服务器地址。和path，path代表了数据库名称</span>
mongoose.connect(<span class="hljs-string">'mongodb://127.0.0.1:27017/myDB'</span>, &#123; <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">useCreateIndex</span>: <span class="hljs-literal">true</span>&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>;&#125;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'数据库连接成功'</span>);
&#125;);
<span class="hljs-comment">// ---------------------分割线----------------------</span>
<span class="hljs-comment">// 2.有账号密码：</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);<span class="hljs-comment">// 引入mongoose模块</span>
<span class="hljs-comment">// 连接mongodb。填入mongodb所在服务器地址。和path，path代表了数据库名称</span>
<span class="hljs-comment">// 并且地址之前使用@分割，@左面填写账号密码。账号密码之间以:隔开</span>
mongoose.connect(<span class="hljs-string">'mongodb://eggadmin:123456@localhost:27017/myDB'</span>, &#123; <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">useCreateIndex</span>: <span class="hljs-literal">true</span>&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>;&#125;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'数据库连接成功'</span>);
&#125;);</code></pre>
<p><strong>tip</strong></p>
<pre><code class="hljs markdown">然后在需要的地方引入对应的文件，即可连接成功</code></pre>

<h3 id="定义模式">定义模式<a class="post-anchor" href="#定义模式"></a></h3><p>模式决定了：1.数据库中行的字段。2.通过Mongoose的Api存储这些字段时的限制和验证</p>
<pre><code class="hljs js"><span class="hljs-comment">// 开始</span>

<span class="hljs-comment">// 1.获取 Schema模式构造函数</span>
<span class="hljs-keyword">const</span> Schema = mongoose.Schema;
<span class="hljs-comment">// 2.定义模式</span>
<span class="hljs-keyword">let</span> schema = <span class="hljs-keyword">new</span> Schema(&#123;
    <span class="hljs-attr">title</span>: &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,<span class="hljs-comment">// 存储行之前，会自动将行内title字段转化成String类型</span>
        <span class="hljs-attr">default</span>: <span class="hljs-string">'baidu.com'</span>,<span class="hljs-comment">// 存储行时如果行内不存在title字段。则使用默认值</span>
    &#125;,
    <span class="hljs-attr">list</span>: &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">Array</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
    &#125;,
&#125;);</code></pre>

<h3 id="根据模式获取模型">根据模式获取模型<a class="post-anchor" href="#根据模式获取模型"></a></h3><p>模型可以对数据库进行《删/改/查》操作。</p>
<pre><code class="hljs js"><span class="hljs-comment">// 开始</span>
<span class="hljs-comment">// 1.获取 model模型构造函数</span>
<span class="hljs-keyword">const</span> model = mongoose.model;
<span class="hljs-comment">// model是构造函数。接受三个参数。</span>
<span class="hljs-comment">//      模式名：&lt;String&gt;任意取，但不可重复</span>
<span class="hljs-comment">//      模式对象：&lt;Object&gt;  上面定义的模式</span>
<span class="hljs-comment">//      要操作的集合的名称：&lt;String&gt;  如没有传入此参数。则默认操作《模式名的复数集合》</span>

<span class="hljs-comment">// 2.获取模型</span>

<span class="hljs-comment">// 例：不传入第三个参数</span>
<span class="hljs-keyword">let</span> Col_user = <span class="hljs-keyword">new</span> model(<span class="hljs-string">'Col_user'</span>, schema);<span class="hljs-comment">// 获取集合实例</span>
<span class="hljs-comment">// 结果：Col_user模型将默认操作《col_users集合》</span>
<span class="hljs-comment">// -----------------分割线------------------</span>
<span class="hljs-comment">// 例：传入第三个参数</span>
<span class="hljs-keyword">let</span> Col_user = <span class="hljs-keyword">new</span> model(<span class="hljs-string">'Col_user'</span>, schema, <span class="hljs-string">'abc'</span>);<span class="hljs-comment">// 获取集合实例</span>
<span class="hljs-comment">// 结果：Col_user模型将默认操作《abc集合》</span></code></pre>

<h4 id="Demo1-1">Demo1<a class="post-anchor" href="#Demo1-1"></a></h4><pre><code class="hljs js"><span class="hljs-keyword">const</span> mongoose=<span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">const</span> fangjiaSchema = <span class="hljs-keyword">new</span> mongoose.Schema(&#123;
  <span class="hljs-attr">xiaoqu_name</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>&#125;,
  <span class="hljs-attr">position</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>&#125;,
  <span class="hljs-attr">price</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">Number</span>&#125;,
  <span class="hljs-attr">picture</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">Array</span>,<span class="hljs-attr">default</span>:[]&#125;,
  <span class="hljs-attr">price_type</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">Number</span>,<span class="hljs-attr">default</span>:<span class="hljs-string">'0'</span>&#125;,
  <span class="hljs-attr">price_rate</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">'0%'</span>&#125;,
  <span class="hljs-attr">floor_area_ratio</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>,<span class="hljs-attr">default</span>:<span class="hljs-string">'暂无数据'</span>&#125;,
  <span class="hljs-attr">total_hu</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"暂无数据"</span>&#125;,
  <span class="hljs-attr">greening_rate</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"暂无数据"</span>&#125;,
  <span class="hljs-attr">property_type</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"公寓住宅"</span>&#125;,
  <span class="hljs-attr">developer</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"暂无数据"</span>&#125;,
  <span class="hljs-attr">property_company</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"暂无数据"</span>&#125;,
  <span class="hljs-attr">creminal_circle</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>, <span class="hljs-attr">default</span>:<span class="hljs-string">"暂无数据"</span>&#125;,
  <span class="hljs-attr">l_time</span>:&#123;<span class="hljs-attr">type</span>:<span class="hljs-built_in">String</span>,<span class="hljs-attr">default</span>:<span class="hljs-built_in">Date</span>.now&#125;
&#125;);

<span class="hljs-comment">// 将schema 对象转化为数据模型</span>
<span class="hljs-keyword">const</span> Fangjia = mongoose.model(<span class="hljs-string">'fangjia'</span>, fangjiaSchema);<span class="hljs-comment">//该数据对象和集合关联('集合名',schema对象)</span>

<span class="hljs-built_in">module</span>.exports=Fangjia;</code></pre>

<h3 id="增加">增加<a class="post-anchor" href="#增加"></a></h3><pre><code class="hljs js"><span class="hljs-keyword">const</span> newUser = &#123;
    username,
    mail,
    <span class="hljs-attr">password</span>: hash
  &#125;;
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> User.insertMany(newUser);</code></pre>

<h3 id="修改">修改<a class="post-anchor" href="#修改"></a></h3><pre><code class="hljs js"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> User.findOneAndUpdate(&#123; <span class="hljs-attr">$and</span>: [ &#123; username &#125;, &#123; mail &#125; ] &#125;,&#123;<span class="hljs-attr">password</span>:newpassword&#125;,&#123;<span class="hljs-attr">new</span>:<span class="hljs-literal">true</span>&#125;);</code></pre>

<h3 id="删除">删除<a class="post-anchor" href="#删除"></a></h3><pre><code class="hljs js"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> Data.findByIdAndDelete(&#123;<span class="hljs-attr">_id</span>: id&#125;);</code></pre>

<h3 id="查找">查找<a class="post-anchor" href="#查找"></a></h3><pre><code class="hljs js"><span class="hljs-comment">// find</span>
<span class="hljs-comment">// 接受两个参数(常用的是两个。其实还有一个options。但是基本用不到)</span>
<span class="hljs-comment">// 参数1：query &lt;Object&gt;</span>
<span class="hljs-comment">// 参数2：callback &lt;Function&gt;</span>
<span class="hljs-comment">//      参数1：err &lt;Object&gt; 默认为null，报错时将变成Object</span>
<span class="hljs-comment">//      参数2：docs &lt;Array&gt;装着《所有符合条件的行》的数组</span>

<span class="hljs-comment">// 例如，这里将查询《abc集合》中name为zs且年龄大于20的所有行,且不返回age字段，并以height排序</span>
Data.find(&#123;<span class="hljs-attr">name</span>: <span class="hljs-string">'zs'</span>, <span class="hljs-attr">age</span>: &#123;<span class="hljs-attr">$gt</span>: <span class="hljs-number">20</span>&#125;&#125;, &#123;<span class="hljs-attr">age</span>:<span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-attr">$sort</span>: &#123;<span class="hljs-attr">height</span>: <span class="hljs-number">-1</span>, <span class="hljs-attr">_id</span>: <span class="hljs-number">-1</span>&#125;&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err)&#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>;&#125;
    <span class="hljs-built_in">console</span>.log(docs, <span class="hljs-string">'查询结果的，数组'</span>);
&#125;)
<span class="hljs-comment">// ---------------------分割线---------------------</span>
<span class="hljs-comment">// findOne和find类似。但是只返回符合条件的第一个行。docs仍然是数组</span></code></pre>

<h3 id="获取符合条件的文档的数量">获取符合条件的文档的数量<a class="post-anchor" href="#获取符合条件的文档的数量"></a></h3><pre><code class="hljs js"><span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> Data.estimatedDocumentCount();</code></pre>

<h3 id="修饰符-数据验证">修饰符/数据验证<a class="post-anchor" href="#修饰符-数据验证"></a></h3><pre><code class="hljs js"><span class="hljs-comment">// 索引将增加《以该字段》为查询条件的————查询速度</span>

<span class="hljs-comment">// 1.用作任意类型的修饰符：</span>
<span class="hljs-keyword">let</span> UserSchema = mongoose.Schema(&#123;
    <span class="hljs-attr">abc</span>: &#123;
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 表示这个数据必须传入</span>
        <span class="hljs-keyword">set</span>(params) &#123;<span class="hljs-comment">// 自定义修饰符set，</span>
            <span class="hljs-comment">// ......做一些处理或者判断。</span>
            <span class="hljs-keyword">return</span> new_params  <span class="hljs-comment">// 返回出被处理过后的params</span>
        &#125;
    &#125;,
    <span class="hljs-comment">// 下面三个为索引类型</span>
    <span class="hljs-attr">uid</span>: &#123;
        <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 为uid字段创建不可以重复的唯一索引，从此以后uid不会出现重复</span>
    &#125;,
    <span class="hljs-attr">age</span>:&#123;
        <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 为age字段创建普通索引</span>
    &#125;,
    <span class="hljs-attr">title</span>: &#123;
        <span class="hljs-attr">sparse</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 为title属性创建稀疏索引</span>
    &#125;
&#125;)
<span class="hljs-comment">// 2.用作String类型的修饰符</span>
<span class="hljs-keyword">let</span> UserSchema = mongoose.Schema(&#123;
    <span class="hljs-attr">name</span>: &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">// 预定义修饰符，如果增加数据时类型不为String，则转换成String类型</span>
        <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 预定义修饰符，去除值两边空格，此修饰符只作用于type:String类型的数据</span>
        <span class="hljs-attr">lowercase</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 预定义修饰符，将值转换为小写，此修饰符只作用于type:String类型的数据</span>
        <span class="hljs-attr">uppercase</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 预定义修饰符，将值转换为大写，此修饰符只作用于type:String类型的数据</span>
        <span class="hljs-attr">enum</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 枚举类型，要求数据必须满足枚举值 enum:['0','1','2']</span>
        <span class="hljs-attr">match</span>: <span class="hljs-regexp">/正则/</span>, <span class="hljs-comment">//增加的数据必须符合 match（正则）的规则</span>
        <span class="hljs-attr">maxlength</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// 最大长度，length最大20</span>
        <span class="hljs-attr">minlength</span>: <span class="hljs-number">10</span> <span class="hljs-comment">// 最小长度，length最小10</span>
    &#125;
&#125;)
<span class="hljs-comment">// 3.用作Number类型的修饰符：</span>
<span class="hljs-keyword">let</span> UserSchema = mongoose.Schema(&#123;
    <span class="hljs-attr">age</span>: &#123;
        <span class="hljs-attr">max</span>: <span class="hljs-number">110</span> ,<span class="hljs-comment">// 用于 Number 类型数据，最大值</span>
        <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> ,<span class="hljs-comment">// 用于 Number 类型数据，最小值</span>
    &#125;
&#125;)
<span class="hljs-comment">// 4.字符串和数字都可以用的</span>
<span class="hljs-keyword">let</span> UserSchema = mongoose.Schema(&#123;
    <span class="hljs-attr">equipment</span>: &#123;<span class="hljs-comment">// 设备信息</span>
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,<span class="hljs-comment">// 必须加这条来指定数据类型，否则报错</span>
        <span class="hljs-attr">enum</span>: [<span class="hljs-string">'pc'</span>, <span class="hljs-string">'mobile'</span>],<span class="hljs-comment">// 可取的值。意为：非该数组内包含的值都是不可取的值，都不会通过验证</span>
        <span class="hljs-attr">default</span>: <span class="hljs-string">'mobile'</span>
    &#125;,
&#125;)</code></pre>

<h3 id="操作符">操作符<a class="post-anchor" href="#操作符"></a></h3><pre><code class="hljs js"><span class="hljs-comment">// $lt  小于：   query = &#123;age: &#123;$lt: 20&#125;&#125;   --- age &lt; 20</span>
<span class="hljs-comment">// $gt  大于：   query = &#123;age: &#123;$gt: 20&#125;&#125;   --- age &gt; 20</span>
<span class="hljs-comment">// $eq  等于：   query = &#123;age: &#123;$eq: 20&#125;&#125;   --- age = 20或者query = &#123;age: 20&#125;</span>
<span class="hljs-comment">// $ne  不等于： query = &#123;age: &#123;$ne: 20&#125;&#125;   --- age != 20</span>
<span class="hljs-comment">// $lte 小于等于 query = &#123;age: &#123;$lte: 20&#125;&#125;  --- age &lt;= 20</span>
<span class="hljs-comment">// $gte 大于等于 query = &#123;age: &#123;$gte: 20&#125;&#125;  --- age &gt;= 20</span>
<span class="hljs-comment">// $or    或    query = &#123;$or: [&#123;name: 'xx'&#125;, &#123;age:&#123;$lt &lt; 20&#125;]&#125;  --- (name === 'xx' || age &lt; 20)</span>
<span class="hljs-comment">// 正则</span>
<span class="hljs-comment">// 例：title中包含服装的</span>
<span class="hljs-comment">// .find(&#123;title:/服装/)</span>
<span class="hljs-comment">// 例：title中以服装开头</span>
<span class="hljs-comment">// .find(&#123;title:/^服装/)</span>

<span class="hljs-comment">// $inc 用来操作数字(用来增加指定字段的数量)    在update函数第二个参数中可以这样写，&#123;$inc:&#123;"price": +20&#125;&#125; ---- 在原price基础上增加20</span>

<span class="hljs-comment">// 关于$set操作符------------------------------------------------------------</span>
<span class="hljs-comment">// $set 在update类函数中，用来声明本次update是更新数据。而不是直接覆盖所有数据</span>
<span class="hljs-comment">// 例子：MongoDB原生语法：将name是zhangsan的数据的age改为15</span>
<span class="hljs-comment">// db.集合名.update(&#123;name:'zhangsan'&#125;,&#123;$set:&#123;age:15&#125;&#125;)</span>
<span class="hljs-comment">// 例子：MongoDB原生语法：将name是zhangsan的那整条数据直接替换为&#123;age:15&#125;</span>
<span class="hljs-comment">// db.集合名.update(&#123;name:'zhangsan'&#125;,&#123;age:15&#125;)</span>
<span class="hljs-comment">// 说明：其实Mongoose的update类函数不再需要显式标明$set也可以只更新，不覆盖。写了也不会有影响。</span>
<span class="hljs-comment">// 但MongoDB必须显示使用$set操作符。否则将直接覆盖</span></code></pre>

<h3 id="聚合管道-高级查询">聚合管道(高级查询)<a class="post-anchor" href="#聚合管道-高级查询"></a></h3><ul>
<li>$project指定返回的列，也就是指定返回哪些字段</li>
<li>$match指定返回符合条件的字段</li>
<li>$group分组和统计</li>
<li>$limit指定只返回最多多少条数据</li>
<li>$skip跳过多少条数据</li>
<li>$lookup表关联查询</li>
<li>$sort排序，指定以什么字段排序，并指定正反序</li>
</ul>
<p><strong>细节</strong></p>
<pre><code class="hljs js"><span class="hljs-comment">// 1.</span>
<span class="hljs-comment">// 如果只有一个操作符，则可以单独使用对象包裹</span>
<span class="hljs-comment">// 例如：</span>
myModel.aggregate(&#123;<span class="hljs-attr">$project</span>:&#123;<span class="hljs-attr">_id</span>:<span class="hljs-literal">false</span>&#125;&#125;)
<span class="hljs-comment">// --------------分割线----------</span>
<span class="hljs-comment">// 如果多个操作符，则必须必须使用数组包裹</span>
<span class="hljs-comment">// 例如：</span>
myModel.aggregate([&#123;<span class="hljs-attr">$project</span>:&#123;<span class="hljs-attr">_id</span>:<span class="hljs-literal">false</span>&#125;&#125;,&#123;<span class="hljs-attr">$limit</span>:<span class="hljs-number">2</span>&#125;])

<span class="hljs-comment">// 2.</span>
<span class="hljs-comment">// aggregate参数数组中的管道顺序会影响最终结果</span>

<span class="hljs-comment">// 3.sort字段的排序，尽量使用双(或以上)字段来排序。否则在分页时很容易会出现重复数据</span></code></pre>

<h4 id="project">$project<a class="post-anchor" href="#project"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 指定返回的列，也就是指定返回哪些字段</span>

<span class="hljs-comment">// 例如：目标：查询order表数据，并且返回的行中字段。只有order_id/name/age三个</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);
Order.aggregate([
    &#123;<span class="hljs-attr">$project</span>:&#123;<span class="hljs-attr">order_id</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">1</span>&#125;&#125;
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;)</code></pre>

<h4 id="match">$match<a class="post-anchor" href="#match"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 指定返回符合条件的字段</span>

<span class="hljs-comment">// 例如：目标：查询order表数据，并且只返回all_price值大于等于90的行</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);
Order.aggregate([
    &#123;<span class="hljs-attr">$match</span>: &#123;<span class="hljs-string">"all_price"</span>: &#123;<span class="hljs-attr">$gte</span>:<span class="hljs-number">90</span>&#125;&#125;&#125;
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;)</code></pre>

<h4 id="group">$group<a class="post-anchor" href="#group"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 分组和统计</span>

<span class="hljs-comment">// 例如：目标：查询order表数据，并以name字段分组，且统计每个组中的age之和</span>
<span class="hljs-comment">// 样本数据：</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "b", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "b", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "c", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "c", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "b", "age" : 23 &#125;</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);    
Oorder.aggregate([
    &#123;<span class="hljs-attr">$group</span>: &#123;<span class="hljs-attr">_id</span>: <span class="hljs-string">"$name"</span>, <span class="hljs-attr">my_num</span>: &#123;<span class="hljs-attr">$sum</span>: <span class="hljs-string">"$age"</span>&#125;&#125;&#125;
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;)

<span class="hljs-comment">// docs返回数据：</span>
<span class="hljs-comment">// &#123; "_id" : "b", "my_num" : 67 &#125;</span>
<span class="hljs-comment">// &#123; "_id" : "c", "my_num" : 44 &#125;</span>
<span class="hljs-comment">// &#123; "_id" : "a", "my_num" : 88 &#125;</span></code></pre>

<h4 id="limit">$limit<a class="post-anchor" href="#limit"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 指定只返回最多多少条数据</span>

<span class="hljs-comment">// 例如：目标：查询order表数据，并最多只返回2条数据</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);
Order.aggregate([
    &#123;<span class="hljs-attr">$limit</span>: <span class="hljs-number">2</span>&#125;
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;)</code></pre>

<h4 id="skip">$skip<a class="post-anchor" href="#skip"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 跳过多少条数据</span>

<span class="hljs-comment">// 例如：目标：查询order表数据，并跳过前三条数据，只返回除了前三条以外的所有数据。</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);
Order.aggregate([
    &#123;<span class="hljs-attr">$skip</span>: <span class="hljs-number">3</span>&#125;
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;)</code></pre>

<h4 id="lookup">$lookup<a class="post-anchor" href="#lookup"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 表关联查询</span>

<span class="hljs-comment">// 例如：将col表和test表关联，以《col表中uid字段》和《test表中ab字段》相关联。将test被关联的行，放到col表的myList数组中</span>
<span class="hljs-keyword">let</span> Col = mongoose.model(<span class="hljs-string">'Col'</span>,UserSchema,<span class="hljs-string">'col'</span>);

<span class="hljs-comment">// col表数据：</span>
<span class="hljs-comment">// &#123;name:'zs',age:'20',uid:1&#125;</span>
<span class="hljs-comment">// &#123;name:'li',age:'20',uid:2&#125;</span>
<span class="hljs-comment">// &#123;name:'wa',age:'20',uid:1&#125;</span>
<span class="hljs-comment">// &#123;name:'xh',age:'20',uid:3&#125;</span>

<span class="hljs-comment">// test表数据：</span>
<span class="hljs-comment">// &#123;u:'fd',price:'20',ab:1&#125;</span>
<span class="hljs-comment">// &#123;u:'afd',price:'20',ab:2&#125;</span>
<span class="hljs-comment">// &#123;u:'yt',price:'30',ab:2&#125;</span>

<span class="hljs-comment">// 执行操作</span>
Col.aggregate([
    &#123;
        <span class="hljs-attr">$lookup</span>: &#123;
            <span class="hljs-attr">from</span>: <span class="hljs-string">'test'</span>, <span class="hljs-comment">// 这里意味和test集合关联</span>
            <span class="hljs-attr">localField</span>: <span class="hljs-string">'uid'</span>,<span class="hljs-comment">// 这里意为用col表中的uid字段和test表中的id字段关联。</span>
            <span class="hljs-attr">foreignField</span>: <span class="hljs-string">'ab'</span>,
            <span class="hljs-attr">as</span>: <span class="hljs-string">'myList'</span> <span class="hljs-comment">// 这里意为，将返回的最终数据，放在一个数组中。并且给该数组key设置为myList</span>
        &#125;
    &#125;
], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, docs</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(docs);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;);
<span class="hljs-comment">// 返回结果，将test表中《ab值》和《col表中uid值》相同的test表数据放到col表的myList数组中</span>
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//     &#123;</span>
<span class="hljs-comment">//         "_id": ObjectId("5d3c603d8cbf5184d6763b4c"),</span>
<span class="hljs-comment">//         "name": "zs",</span>
<span class="hljs-comment">//         "age": "20",</span>
<span class="hljs-comment">//         "uid": 1,</span>
<span class="hljs-comment">//         "myList": [</span>
<span class="hljs-comment">//             &#123;</span>
<span class="hljs-comment">//                 "_id": ObjectId("5d3c62888cbf5184d6763b53"),</span>
<span class="hljs-comment">//                 "u": "fd",</span>
<span class="hljs-comment">//                 "price": "20",</span>
<span class="hljs-comment">//                 "ab": 1</span>
<span class="hljs-comment">//             &#125;</span>
<span class="hljs-comment">//         ]</span>
<span class="hljs-comment">//     &#125;,</span>
<span class="hljs-comment">//     &#123;</span>
<span class="hljs-comment">//         "_id": ObjectId("5d3c603d8cbf5184d6763b4d"),</span>
<span class="hljs-comment">//         "name": "li",</span>
<span class="hljs-comment">//         "age": "20",</span>
<span class="hljs-comment">//         "uid": 2,</span>
<span class="hljs-comment">//         "myList": [</span>
<span class="hljs-comment">//             &#123;</span>
<span class="hljs-comment">//                 "_id": ObjectId("5d3c62888cbf5184d6763b54"),</span>
<span class="hljs-comment">//                 "u": "afd",</span>
<span class="hljs-comment">//                 "price": "20",</span>
<span class="hljs-comment">//                 "ab": 2</span>
<span class="hljs-comment">//             &#125;,</span>
<span class="hljs-comment">//             &#123;</span>
<span class="hljs-comment">//                 "_id": ObjectId("5d3c62888cbf5184d6763b55"),</span>
<span class="hljs-comment">//                 "u": "yt",</span>
<span class="hljs-comment">//                 "price": "30",</span>
<span class="hljs-comment">//                 "ab": 2</span>
<span class="hljs-comment">//             &#125;</span>
<span class="hljs-comment">//         ]</span>
<span class="hljs-comment">//     &#125;,</span>
<span class="hljs-comment">//     &#123;</span>
<span class="hljs-comment">//         "_id": ObjectId("5d3c603d8cbf5184d6763b4e"),</span>
<span class="hljs-comment">//         "name": "wa",</span>
<span class="hljs-comment">//         "age": "20",</span>
<span class="hljs-comment">//         "uid": 1,</span>
<span class="hljs-comment">//         "myList": [</span>
<span class="hljs-comment">//             &#123;</span>
<span class="hljs-comment">//                 "_id": ObjectId("5d3c62888cbf5184d6763b53"),</span>
<span class="hljs-comment">//                 "u": "fd",</span>
<span class="hljs-comment">//                 "price": "20",</span>
<span class="hljs-comment">//                 "ab": 1</span>
<span class="hljs-comment">//             &#125;</span>
<span class="hljs-comment">//         ]</span>
<span class="hljs-comment">//     &#125;,</span>
<span class="hljs-comment">//     &#123;</span>
<span class="hljs-comment">//         "_id": ObjectId("5d3c603d8cbf5184d6763b4f"),</span>
<span class="hljs-comment">//         "name": "xh",</span>
<span class="hljs-comment">//         "age": "20",</span>
<span class="hljs-comment">//         "uid": 3,</span>
<span class="hljs-comment">//         "myList": []</span>
<span class="hljs-comment">//     &#125;</span>
<span class="hljs-comment">// ]</span></code></pre>

<h4 id="sort">$sort<a class="post-anchor" href="#sort"></a></h4><pre><code class="hljs js"><span class="hljs-comment">// 排序，指定以什么字段排序，并指定正反序</span>
<span class="hljs-keyword">let</span> Order = mongoose.model(<span class="hljs-string">'Order'</span>,UserSchema,<span class="hljs-string">'order'</span>);

<span class="hljs-comment">// 样本数据：</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 36 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "b", "age" : 18 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "c", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "d", "age" : 15 &#125;</span>
Order.aggregate([
    &#123;<span class="hljs-attr">$sort</span>: &#123;<span class="hljs-string">"age"</span>: <span class="hljs-number">-1</span>, <span class="hljs-attr">_id</span>: <span class="hljs-number">-1</span>&#125;&#125;;<span class="hljs-comment">// 注意，无论以什么排序，最好用双字段进行排序。防止查询出重复数据</span>
],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,doc</span>)</span>&#123;
    <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
    <span class="hljs-built_in">console</span>.log(doc);<span class="hljs-comment">// 返回最终查询到的数据</span>
&#125;);
<span class="hljs-comment">// -1结果是倒序：</span>
<span class="hljs-comment">// &#123; "name" : "a", "age" : 36 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "c", "age" : 22 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "b", "age" : 18 &#125;</span>
<span class="hljs-comment">// &#123; "name" : "d", "age" : 15 &#125;</span>

<span class="hljs-comment">// 1则结果为正序。</span></code></pre>

<h3 id="小结">小结<a class="post-anchor" href="#小结"></a></h3><p><strong>用aggregate写一个分页</strong></p>
<pre><code class="hljs js"><span class="hljs-comment">// node中分页接口</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getList</span>(<span class="hljs-params">request, response, next</span>) </span>&#123;
    <span class="hljs-keyword">let</span> &#123;page = <span class="hljs-number">1</span>, size = <span class="hljs-number">8</span>, category_type = <span class="hljs-string">''</span>, condition = <span class="hljs-string">''</span>&#125; = request.body;
    <span class="hljs-keyword">let</span> reg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(condition, <span class="hljs-string">'gi'</span>);
    <span class="hljs-keyword">let</span> match = &#123;<span class="hljs-attr">category_type</span>: category_type, <span class="hljs-attr">$or</span>:[&#123;<span class="hljs-attr">title</span>: reg&#125;]&#125;;
    userModel.countDocuments(match, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, count</span>) </span>&#123;
        size = size &gt; <span class="hljs-number">30</span> ? <span class="hljs-number">30</span> : <span class="hljs-built_in">parseInt</span>(size);
        size = size &lt; <span class="hljs-number">8</span> ? <span class="hljs-number">8</span> : <span class="hljs-built_in">parseInt</span>(size);
        <span class="hljs-keyword">let</span> maxPage = <span class="hljs-built_in">Math</span>.ceil(count / size);
        page = page &gt; maxPage ? maxPage : <span class="hljs-built_in">parseInt</span>(page);
        page = page - <span class="hljs-number">1</span>;
        page  = page &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-built_in">parseInt</span>(page);
        <span class="hljs-comment">// 注意管道顺序，会影响结果</span>
        dbs.aggregate([
            &#123;<span class="hljs-attr">$match</span>: match&#125;,
            &#123;<span class="hljs-attr">$sort</span>: &#123; <span class="hljs-attr">href</span>: <span class="hljs-number">-1</span>, <span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>&#125;&#125;,
            &#123;<span class="hljs-attr">$project</span>: &#123;<span class="hljs-attr">href</span>: <span class="hljs-literal">false</span>&#125;&#125;,
            &#123;<span class="hljs-attr">$skip</span>: page * size * <span class="hljs-number">1</span>&#125;,
            &#123;<span class="hljs-attr">$limit</span>: size * <span class="hljs-number">1</span> &#125;
        ],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,doc</span>)</span>&#123;
            <span class="hljs-keyword">if</span>(err) &#123;<span class="hljs-built_in">console</span>.log(err);<span class="hljs-keyword">return</span>&#125;
            <span class="hljs-keyword">return</span> response.json(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">'数据获取成功'</span>, <span class="hljs-attr">data</span>: &#123;<span class="hljs-attr">page</span>: page+<span class="hljs-number">1</span>, size, maxPage, condition, <span class="hljs-attr">list</span>: doc&#125;&#125;);
        &#125;);
    &#125;)
&#125;</code></pre>

<h3 id="分页">分页<a class="post-anchor" href="#分页"></a></h3><pre><code class="hljs js">exports.getpagination = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;
  <span class="hljs-keyword">const</span> pageSize = <span class="hljs-built_in">parseInt</span>(req.query.pageSize) || <span class="hljs-number">5</span>;
  <span class="hljs-keyword">const</span> currentPage = <span class="hljs-built_in">parseInt</span>(req.query.currentPage) || <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> keyword =req.query.keyword || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> reg=<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(keyword);

  <span class="hljs-keyword">const</span> sorttype = req.query.sort;
  <span class="hljs-keyword">let</span> sort =  &#123;&#125;;
  <span class="hljs-keyword">if</span> (sorttype)&#123;
    <span class="hljs-keyword">const</span> isDesc = sorttype === <span class="hljs-string">'升序'</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
    sort = &#123;<span class="hljs-string">'price'</span>:isDesc&#125;;        <span class="hljs-comment">//排序（按价格倒序）</span>
  &#125;

  <span class="hljs-keyword">const</span> condition = &#123;
    <span class="hljs-attr">$or</span>:[&#123;<span class="hljs-attr">xiaoqu_name</span>:&#123;<span class="hljs-attr">$regex</span>:reg&#125;&#125;,&#123;<span class="hljs-attr">position</span>:&#123;<span class="hljs-attr">$regex</span>:reg&#125;&#125;,&#123;<span class="hljs-attr">creminal_circle</span>:&#123;<span class="hljs-attr">$regex</span>:reg&#125;&#125;]
  &#125;;

  <span class="hljs-keyword">const</span> skipnum = (currentPage - <span class="hljs-number">1</span>) * pageSize;   <span class="hljs-comment">//跳过数</span>

  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> Data.estimatedDocumentCount();

  <span class="hljs-keyword">if</span> (sorttype)&#123;
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> Data.find(condition).skip(skipnum).limit(pageSize).sort(sort).exec();
    res.send(&#123;<span class="hljs-attr">code</span>:<span class="hljs-number">200</span>,<span class="hljs-attr">msg</span>:<span class="hljs-string">'查询ok'</span>,<span class="hljs-attr">info</span>:&#123;<span class="hljs-attr">list</span>:result,count,<span class="hljs-attr">allpage</span>:<span class="hljs-built_in">Math</span>.ceil(count/pageSize)&#125;&#125;)
  &#125;
  <span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> Data.find(condition).skip(skipnum).limit(pageSize).sort(&#123;<span class="hljs-attr">_id</span>:<span class="hljs-number">-1</span>&#125;).exec();
    res.send(&#123;<span class="hljs-attr">code</span>:<span class="hljs-number">200</span>,<span class="hljs-attr">msg</span>:<span class="hljs-string">'查询ok'</span>,<span class="hljs-attr">info</span>:&#123;<span class="hljs-attr">list</span>:result,count,<span class="hljs-attr">allpage</span>:<span class="hljs-built_in">Math</span>.ceil(count/pageSize)&#125;&#125;)
  &#125;
&#125;;</code></pre>


  
    <div class="post-reward">
    <div id="reward-button">打赏</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
              微信
            </div>
            
        </div>
      </div>
    </div>
  
  <div class="post-guide">
    <div class="item left">
        
          <a href="/2020/08/19/mongoose%E6%93%8D%E4%BD%9C%E6%95%B0%E7%BB%84/">mongoose操作数组</a>
        
    </div>
    <div class="item right">
        
          <a href="/2020/08/19/scss%E8%AF%AD%E6%B3%95/">scss语法</a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="https://codermino.github.io">Mino</a>
    </div>
    <div class="link">
      永久链接：<a href="https://codermino.github.io/2020/08/19/mongoose操作/">https://codermino.github.io/2020/08/19/mongoose操作/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="https://codermino.github.io">Mino</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
        <footer>
          <div class="copyright">
            ©2022
            <a href="https://codermino.github.io">Mino</a> Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Mino</a> |
<!--            <a href="https://github.com/shixiaohu2206/hexo-theme-huhu" target="_blank" rel="noopener">hexo-theme-huhu</a>-->
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
