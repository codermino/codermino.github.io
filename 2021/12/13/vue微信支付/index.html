<!DOCTYPE html>
<html>
  <head>
      <script>
  var _hmt = _hmt || []
  ;(function() {
    var hm = document.createElement('script')
    hm.src = 'https://hm.baidu.com/hm.js?5a0acc897fd96474a2c8f4deac84611a'
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(hm, s)
  })()
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="Mino,前端,后端,全栈,NodeJs,JavaScript" />
    <meta name="description" content="Mino&#39;s personal blog" />
    
    <title>
      vue微信支付 - Mino
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/style/style.css">
  <link rel="alternate" href="/atom.xml" title="Mino" type="application/atom+xml">
</head>
  <body>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前端逻辑"><span class="toc-text">前端逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部分代码"><span class="toc-text">部分代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整代码"><span class="toc-text">完整代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后端逻辑-node"><span class="toc-text">后端逻辑(node)</span></a></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.jpg" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          首页
        </a>
        
        <a href="/about" class="">
          关于
        </a>
        
        <a href="/tags" class="">
          标签
        </a>
        
        <a href="/categories" class="">
          分类
        </a>
        
        <a href="/archives" class="">
          归档
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        <div class="author">Mino</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">Mino</div>
          <a href="/" class="logo" style="background-image: url('/images/logo.jpg')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            首页
          </a>
          
          <a href="/about" class="">
            关于
          </a>
          
          <a href="/tags" class="">
            标签
          </a>
          
          <a href="/categories" class="">
            分类
          </a>
          
          <a href="/archives" class="">
            归档
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/codermino" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="1227657064@qq.com" target="_block">
              <span class="iconfont icon-QQ"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">vue微信支付</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2021/12/13</span>
        </span>

        

         
        <span class="item">
          <span class="iconfont icon-folder"></span>
          <span>
              
                
                  <a href="/categories/vue">vue</a>
                
              
          </span>
        </span>
        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/vue微信支付">vue微信支付</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <p><a href="/images/vuepic/vue.jpg" data-caption data-fancybox="images"><img src="/images/vuepic/vue.jpg" alt></a></p>
<h2 id="前端逻辑">前端逻辑<a class="post-anchor" href="#前端逻辑"></a></h2><h3 id="部分代码">部分代码<a class="post-anchor" href="#部分代码"></a></h3><p>相比较微信的其他方式支付扫描二维码支付算是比较便捷的</p>
<ol>
<li><p>首先有一个生成订单的按钮，点击按钮调用后台接口生成一个订单ID</p>
<pre><code class="hljs javascript">btnZhiFuClick() &#123;
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-comment">// 生成订单这里 后台要什么传什么就行</span>
    <span class="hljs-keyword">let</span> obj = &#123;
        <span class="hljs-attr">token</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">originalPrice</span>: <span class="hljs-number">1</span>
    &#125;
    <span class="hljs-keyword">this</span>.$http.post(<span class="hljs-string">''</span>, <span class="hljs-keyword">this</span>.obj)
    .then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(res.status == <span class="hljs-string">'200'</span>)&#123;
            self.orderId = res.data <span class="hljs-comment">//拿到后台返回的订单ID后保存到全局变量中 或者 传到调用微信的方法里</span>
            <span class="hljs-keyword">this</span>.weixincode() <span class="hljs-comment">//调用微信支付方法</span>
        &#125;
　　&#125;)
&#125;</code></pre></li>
<li><p>调用微信支付方法</p>
<pre><code class="hljs javascript">weixincode() &#123;
     <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>
     <span class="hljs-keyword">this</span>.$http.post(<span class="hljs-string">''</span>,&#123;&#125;)
     .then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
         <span class="hljs-comment">// 后台传过来的是一串code，用这个来生成二维码</span>
　　　　  self.datacode = res.data
         <span class="hljs-comment">// 调用一个生成二维码的方法</span>
         <span class="hljs-keyword">this</span>.init()
　　　&#125;)
&#125;</code></pre>
</li>
<li><p>生成二维码</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"boxShow"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"qrcode"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"qrcode"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
　　<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>扫描二维码支付<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre>
<pre><code class="hljs javascript">init()&#123;
    <span class="hljs-keyword">this</span>.boxShow = <span class="hljs-literal">true</span>
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"qrcode"</span>).innerHTML = <span class="hljs-string">""</span>; <span class="hljs-comment">//获取生成二维码后显示的容器的ID</span>
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">this</span>.qrCode = <span class="hljs-keyword">new</span> QRCode(<span class="hljs-string">'qrcode'</span>,&#123;
      <span class="hljs-attr">width</span>:<span class="hljs-number">150</span>,                     <span class="hljs-comment">//二维码的宽度</span>
      <span class="hljs-attr">height</span>:<span class="hljs-number">150</span>,                    <span class="hljs-comment">//二维码的高度</span>
      <span class="hljs-comment">// text:self.datacode,            //调用weixincode()方法时后台传的code</span>
      <span class="hljs-attr">text</span>: <span class="hljs-string">'weixin://wxpay/bizpayurl/up?pr=NwY5Mz9&amp;groupid=00'</span>,
      <span class="hljs-comment">//调用weixincode()方法时后台传的code</span>
      <span class="hljs-attr">colorDark</span>:<span class="hljs-string">'#000'</span>,              <span class="hljs-comment">//二维码颜色</span>
      <span class="hljs-attr">colorLight</span>:<span class="hljs-string">'#fff'</span>,             <span class="hljs-comment">//二维码底色</span>
    &#125;)
    <span class="hljs-comment">// 生成的二维码会带有一个title属性，这个title属性的值为text的值</span>
    <span class="hljs-comment">// 可以使用下面的代码将title属性去掉</span>
    <span class="hljs-comment">// document.getElementById("qrcode").setAttribute('title','')</span>
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"qrcode"</span>).removeAttribute(<span class="hljs-string">'title'</span>)
    self.getOrderstate() <span class="hljs-comment">//生成二维码的时候调用监听支付是否成功的方法</span>
  &#125;</code></pre>
</li>
<li><p>前面三步完事后正常情况下就应该可以生成出来一个二维码了，<br>而且用手机测的话应该已经可以支付，还没完呢，<br>用这个方法还有一个功能没有完善，那就是用户支付完并没有跳转，<br>这样用户也不知道什么情况，所以我们继续</p>
<pre><code class="hljs javascript">getOrderstate()&#123;
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">let</span> num = <span class="hljs-number">0</span>
    <span class="hljs-comment">//创建一个全局的定时器</span>
    self.timers = setInterval(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>&#123;
        num ++ 
        <span class="hljs-keyword">let</span> obj = &#123;
            <span class="hljs-attr">token</span>: <span class="hljs-string">'123'</span>,
            <span class="hljs-attr">orderId</span>: <span class="hljs-string">'123'</span>, <span class="hljs-comment">//后台用的是订单判断</span>
        &#125;
        <span class="hljs-keyword">this</span>.$http.post(<span class="hljs-string">''</span>, obj)
        .then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
            <span class="hljs-keyword">if</span>(res.data.data == <span class="hljs-literal">true</span>)&#123; <span class="hljs-comment">//判断 如果data.data==true就是订单支付成功</span>
                <span class="hljs-keyword">this</span>.$router.push(&#123;
                    <span class="hljs-attr">path</span>: <span class="hljs-string">'/chenggong'</span>, <span class="hljs-comment">//成功以后的跳转路径</span>
                &#125;)
                clearInterval(<span class="hljs-keyword">this</span>.timers) <span class="hljs-comment">//别忘记关闭定时器，否则会一直调这个接口</span>
            &#125;
        &#125;)
        <span class="hljs-keyword">if</span>(num == <span class="hljs-number">500</span>)&#123; <span class="hljs-comment">//这里是判断num++到500的情况下用户还没有支付则自动关闭定时器和二维码</span>
            <span class="hljs-keyword">this</span>.boxShow = <span class="hljs-literal">false</span>
            clearInterval(<span class="hljs-keyword">this</span>.timers)
        &#125;
　　 &#125;,<span class="hljs-number">1500</span>)
&#125;</code></pre>
</li>
<li><p>清除定时器</p>
<pre><code class="hljs javascript">beforeDestroy() &#123;
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.timers) &#123;
       clearInterval(<span class="hljs-keyword">this</span>.timers); <span class="hljs-comment">//关闭</span>
  &#125;  
 &#125;</code></pre>

</li>
</ol>
<h3 id="完整代码">完整代码<a class="post-anchor" href="#完整代码"></a></h3><pre><code class="hljs vue">&lt;template&gt;
  &lt;div class&#x3D;&quot;hello&quot;&gt;
    &lt;button @click&#x3D;&quot;btnZhiFuClick&quot;&gt;发起支付&lt;&#x2F;button&gt;
    &lt;div v-show&#x3D;&quot;boxShow&quot;&gt;
      &lt;div id&#x3D;&quot;qrcode&quot; ref&#x3D;&quot;qrcode&quot;&gt;&lt;&#x2F;div&gt;
  　　&lt;p&gt;扫描二维码支付&lt;&#x2F;p&gt;
    &lt;&#x2F;div&gt;
  &lt;&#x2F;div&gt;
&lt;&#x2F;template&gt;

&lt;script&gt;
  import QRCode from &#39;qrcodejs2&#39;
  export default &#123;
    name: &#39;HelloWorld&#39;,
    data() &#123;
      return &#123;
        boxShow: false
      &#125;
    &#125;,
    methods: &#123;
      btnZhiFuClick()&#123;
        let self &#x3D; this;
        let obj &#x3D; &#123; &#x2F;&#x2F;生成订单这里 后台要什么传什么就行&#x2F;&#x2F;
        &#125;
        this.weixincode()
        &#x2F;&#x2F; this.$http.post(&#39;&#39;, obj).then(res&#x3D;&gt;&#123;
        &#x2F;&#x2F;   if(res.status &#x3D;&#x3D; &#39;200&#39;)&#123;
        &#x2F;&#x2F;     self.orderId &#x3D; res.data &#x2F;&#x2F;拿到后台返回的订单ID后保存到全局变量中 或者 传到调用微信的方法里
        &#x2F;&#x2F;     this.weixincode() &#x2F;&#x2F;调用微信支付方法
        &#x2F;&#x2F;   &#125;
        &#x2F;&#x2F; &#125;)
      &#125;,
      weixincode()&#123;
        let self &#x3D; this
        this.init()
        &#x2F;&#x2F; this.$http.post(&#39;&#39;,&#123;&#125;).then(res&#x3D;&gt;&#123;
        &#x2F;&#x2F;   self.datacode &#x3D; res.data &#x2F;&#x2F;后台传过来的是一串code，用这个来生成二维码
        &#x2F;&#x2F;   this.init() &#x2F;&#x2F;调用一个生成二维码的方法
        &#x2F;&#x2F; &#125;)
      &#125;,
      init()&#123;
        this.boxShow &#x3D; true
        document.getElementById(&quot;qrcode&quot;).innerHTML &#x3D; &quot;&quot;; &#x2F;&#x2F;获取生成二维码后显示的容器的ID
        let self &#x3D; this
        this.qrCode &#x3D; new QRCode(&#39;qrcode&#39;,&#123;
          width:150,                     &#x2F;&#x2F;二维码的宽度
          height:150,                    &#x2F;&#x2F;二维码的高度
          &#x2F;&#x2F; text:self.datacode,            &#x2F;&#x2F;调用weixincode()方法时后台传的code
          &#x2F;&#x2F; text: &#39;https:&#x2F;&#x2F;cz.douyu.com&#x2F;i&#x2F;28f60990cbe9f6a6f20a09f2f33d8889&#39;,
          text: &#39;weixin:&#x2F;&#x2F;wxpay&#x2F;bizpayurl&#x2F;up?pr&#x3D;NwY5Mz9&amp;groupid&#x3D;00&#39;,
          &#x2F;&#x2F;调用weixincode()方法时后台传的code
          colorDark:&#39;#000&#39;,              &#x2F;&#x2F;二维码颜色
          colorLight:&#39;#fff&#39;,             &#x2F;&#x2F;二维码底色
        &#125;)
        self.getOrderstate() &#x2F;&#x2F;生成二维码的时候调用监听支付是否成功的方法
      &#125;,
      getOrderstate()&#123;
        let self &#x3D; this;
        let num &#x3D; 0
        console.log(&#39;支付成功&#39;)
        &#x2F;&#x2F; self.timers &#x3D; setInterval(()&#x3D;&gt;&#123; &#x2F;&#x2F;创建一个全局的定时器
        &#x2F;&#x2F;   num ++
        &#x2F;&#x2F;   let obj &#x3D; &#123;
        &#x2F;&#x2F;     token:&#39;123&#39;,
        &#x2F;&#x2F;     orderId:self.orderId.data, &#x2F;&#x2F;后台用的是订单判断
        &#x2F;&#x2F;   &#125;
        &#x2F;&#x2F;   this.$http.post(&#39;&#39;, obj).then(res&#x3D;&gt;&#123;
        &#x2F;&#x2F;     if(res.data.data &#x3D;&#x3D;&#x3D; true)&#123; &#x2F;&#x2F;判断 如果data.data&#x3D;&#x3D;true就是订单支付成功
        &#x2F;&#x2F;       this.$router.push(&#123;
        &#x2F;&#x2F;         path: &#39;&#x2F;pintuanchenggong&#39;, &#x2F;&#x2F;成功以后的跳转路径
        &#x2F;&#x2F;       &#125;)
        &#x2F;&#x2F;       clearInterval(this.timers) &#x2F;&#x2F;别忘记关闭定时器，否则会一直调这个接口
        &#x2F;&#x2F;     &#125;
        &#x2F;&#x2F;   &#125;)
        &#x2F;&#x2F;   if(num &#x3D;&#x3D;&#x3D; 500)&#123; &#x2F;&#x2F;这里是判断num++到500的情况下用户还没有支付则自动关闭定时器和二维码
        &#x2F;&#x2F;     this.boxShow &#x3D; false
        &#x2F;&#x2F;     clearInterval(this.timers)
        &#x2F;&#x2F;   &#125;
        &#x2F;&#x2F; &#125;,1500)
      &#125;
    &#125;,
    beforeDestroy() &#123;
      if(this.timers) &#123;
        clearInterval(this.timers); &#x2F;&#x2F;关闭
      &#125;
    &#125;
  &#125;
&lt;&#x2F;script&gt;</code></pre>

<h2 id="后端逻辑-node">后端逻辑(node)<a class="post-anchor" href="#后端逻辑-node"></a></h2><p><strong>这里只是演示代码，并不代表真实情况</strong></p>
<pre><code class="hljs javascript"><span class="hljs-comment">/*
1. AppID
2. AppSecret
3. 确保获取微信支付接口的权限
4. 获取微信支付的商户号
5. 获取微信支付接口的秘钥(账户中心-&gt;api安全)
6. 同时在产品中心-&gt;开发配置页面，将支付域名配置好：
 */</span>

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
<span class="hljs-keyword">const</span> xml2js = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xml2js'</span>)
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>)
<span class="hljs-comment">// 微信支付接口的数据都是xml, 为了方便, 需要将 xml 转换成 json</span>
<span class="hljs-keyword">const</span> xmlParser = <span class="hljs-keyword">new</span> xml2js.Parser()

<span class="hljs-comment">// 一些需要用的变量</span>
<span class="hljs-comment">// 接收支付结果通知的地址</span>
<span class="hljs-comment">// 后端回调地址是验证这笔订单已经成功付款的服务器间交互的依据，该地址不应该随意泄露或告知他人</span>
<span class="hljs-keyword">const</span> payNotifyUrl = <span class="hljs-string">'https:xxx.com/notify'</span>
<span class="hljs-comment">// 微信公众号的 appid</span>
<span class="hljs-keyword">const</span> appId = <span class="hljs-string">'xxxxxxxx'</span>
<span class="hljs-comment">// 商户号</span>
<span class="hljs-keyword">const</span> mchId = <span class="hljs-string">'yyyyyy'</span>
<span class="hljs-comment">// 支付密钥</span>
<span class="hljs-keyword">const</span> PAY_API_KEY = <span class="hljs-string">'xyxyxyxyx'</span>

<span class="hljs-comment">// md5 加密算法</span>
<span class="hljs-keyword">const</span> md5 = <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> &#123;
    <span class="hljs-keyword">let</span> m = crypto.createHash(<span class="hljs-string">'md5'</span>)
    <span class="hljs-keyword">return</span> m.update(str).digest(<span class="hljs-string">'hex'</span>)
&#125;

<span class="hljs-comment">// 生成一个随机字符串</span>
<span class="hljs-keyword">const</span> getNonceStr = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
    <span class="hljs-keyword">let</span> text = <span class="hljs-string">""</span>
    <span class="hljs-keyword">const</span> possible = <span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) &#123;
        text += possible.charAt(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * possible.length))
    &#125;
    <span class="hljs-keyword">return</span> text
&#125;

<span class="hljs-comment">/*参数说明
* appId: 微信支付分配的公众账号ID（企业号corpid即为此appid）
* attach: 附加数据，在查询API和支付通知中原样返回，可作为自定义参数使用。
* productIntro:商品简单描述，该字段请按照规范传递，具体请见参数规定
* mchId: 微信支付分配的商户号
* nonceStr:随机字符串，长度要求在32位以内。推荐随机数生成算法
* notifyUrl: body异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。公网域名必须为https，如果是走专线接入，使用专线NAT IP或者私有回调域名可使用http
* openId: 非必填
* tradeId:商户系统内部订单号，要求32个字符内（最少6个字符），只能是数字、大小写字母_-|*且在同一个商户号下唯一。详见商户订单号
* ip:终端ip 支持IPV4和IPV6两种格式的IP地址。用户的客户端IP
* price:订单总金额，单位为分，详见支付金额
* trade_type: JSAPI -JSAPI支付 NATIVE -Native支付 APP -APP支付
* PAY_API_KEY: 商户支付密钥
* */</span>

<span class="hljs-comment">// 生成预支付签名, 将会发到微信支付接口</span>
<span class="hljs-keyword">const</span> getPcPrePaySignForWX = <span class="hljs-function">(<span class="hljs-params">appId, attach, productIntro, mchId, nonceStr, notifyUrl, openId, tradeId, ip, price, PAY_API_KEY</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">let</span> stringA = <span class="hljs-string">'appid='</span> + appId +
        <span class="hljs-string">'&amp;attach='</span> + attach +
        <span class="hljs-string">'&amp;body='</span> + productIntro +
        <span class="hljs-string">'&amp;mch_id='</span> + mchId +
        <span class="hljs-string">'&amp;nonce_str='</span> + nonceStr +
        <span class="hljs-string">'&amp;notify_url='</span> + payNotifyUrl +
        <span class="hljs-string">'&amp;out_trade_no='</span> + tradeId +
        <span class="hljs-string">'&amp;spbill_create_ip='</span> + ip +
        <span class="hljs-string">'&amp;total_fee='</span> + price +
        <span class="hljs-string">'&amp;trade_type=NATIVE'</span>
    <span class="hljs-keyword">let</span> stringSignTemp = stringA + <span class="hljs-string">'&amp;key='</span> + PAY_API_KEY
    <span class="hljs-keyword">return</span> md5(stringSignTemp).toUpperCase()
&#125;

<span class="hljs-comment">// 按照要求的格式打包将要发送给微信的数据</span>
<span class="hljs-keyword">const</span> wxPcSendData = <span class="hljs-function">(<span class="hljs-params">appId, attach, productIntro, mchId, nonceStr, openId, tradeId, ip, price, sign</span>) =&gt;</span> &#123;
    <span class="hljs-comment">// attach 将会在通知支付结果时返回</span>
    <span class="hljs-keyword">return</span> sendData = <span class="hljs-string">'&lt;xml&gt;'</span> +
        <span class="hljs-string">'&lt;appid&gt;'</span> + appId + <span class="hljs-string">'&lt;/appid&gt;'</span> +
        <span class="hljs-string">'&lt;attach&gt;'</span> + attach + <span class="hljs-string">'&lt;/attach&gt;'</span> +
        <span class="hljs-string">'&lt;body&gt;'</span> + productIntro + <span class="hljs-string">'&lt;/body&gt;'</span> +
        <span class="hljs-string">'&lt;mch_id&gt;'</span> + mchId + <span class="hljs-string">'&lt;/mch_id&gt;'</span> +
        <span class="hljs-string">'&lt;nonce_str&gt;'</span> + nonceStr + <span class="hljs-string">'&lt;/nonce_str&gt;'</span> +
        <span class="hljs-string">'&lt;notify_url&gt;'</span> + payNotifyUrl + <span class="hljs-string">'&lt;/notify_url&gt;'</span> +
        <span class="hljs-string">'&lt;out_trade_no&gt;'</span> + tradeId + <span class="hljs-string">'&lt;/out_trade_no&gt;'</span> +
        <span class="hljs-string">'&lt;spbill_create_ip&gt;'</span> + ip + <span class="hljs-string">'&lt;/spbill_create_ip&gt;'</span> +
        <span class="hljs-string">'&lt;total_fee&gt;'</span> + price + <span class="hljs-string">'&lt;/total_fee&gt;'</span> +
        <span class="hljs-string">'&lt;trade_type&gt;NATIVE&lt;/trade_type&gt;'</span> +
        <span class="hljs-string">'&lt;sign&gt;'</span> + sign + <span class="hljs-string">'&lt;/sign&gt;'</span> +
        <span class="hljs-string">'&lt;/xml&gt;'</span>
&#125;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pcPaySign</span>(<span class="hljs-params">tradeId, ip</span>) </span>&#123;
    <span class="hljs-keyword">const</span> nonceStr = getNonceStr()
    <span class="hljs-comment">// 交易的费用, 单位是分</span>
    <span class="hljs-keyword">let</span> price = <span class="hljs-number">1</span>
    <span class="hljs-comment">// 交易的描述, 将会出现在用户的微信支付详情中</span>
    <span class="hljs-keyword">let</span> productIntro = <span class="hljs-string">'productIntro'</span>
    <span class="hljs-keyword">const</span> prePaySign = getPcPrePaySignForWX(appId, <span class="hljs-string">'xxx'</span>, productIntro, mchId, nonceStr, payNotifyUrl, openId, tradeId, ip, price, PAY_API_KEY)
    <span class="hljs-keyword">const</span> data = wxPcSendData(appId, <span class="hljs-string">'gankerex'</span>, productIntro, mchId, nonceStr, openId, tradeId, ip, price, prePaySign)
    <span class="hljs-keyword">let</span> wxResponse
    <span class="hljs-keyword">try</span> &#123;
        wxResponse = <span class="hljs-keyword">await</span> axios.post(<span class="hljs-string">'https://api.mch.weixin.qq.com/pay/unifiedorder'</span>, data)
        xmlParser.parseString(wxResponse.data, (err, success) =&gt; &#123;
            <span class="hljs-keyword">if</span> (err) &#123;
                <span class="hljs-comment">//</span>
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-keyword">if</span> (success.xml.return_code[<span class="hljs-number">0</span>] === <span class="hljs-string">'SUCCESS'</span>) &#123;
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'pc pay'</span>, success.xml)
                    <span class="hljs-keyword">const</span> prepayId = success.xml.prepay_id[<span class="hljs-number">0</span>]
                    <span class="hljs-comment">// 这里拿到的这个地址, 将它返回给前端同学即可</span>
                    <span class="hljs-keyword">const</span> codeUrl = success.xml.code_url[<span class="hljs-number">0</span>]
                &#125;
            &#125;
        &#125;)
    &#125; <span class="hljs-keyword">catch</span> (e) &#123;

    &#125;
&#125;

<span class="hljs-comment">// 生成查询签名, 将会发到微信查询接口</span>
<span class="hljs-keyword">const</span> getPcCheckSignForWX = <span class="hljs-function">(<span class="hljs-params">out_trade_no, appid, mch_id, nonce_str</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">let</span> stringA = <span class="hljs-string">'appid='</span> + appid +
        <span class="hljs-string">'&amp;mch_id='</span> + mch_id +
        <span class="hljs-string">'&amp;nonce_str='</span> + nonce_str +
        <span class="hljs-string">'&amp;out_trade_no='</span> + out_trade_no
    <span class="hljs-keyword">let</span> stringSignTemp = stringA + <span class="hljs-string">'&amp;key='</span> + PAY_API_KEY
    <span class="hljs-keyword">return</span> md5(stringSignTemp).toUpperCase()
&#125;

<span class="hljs-comment">// 按照要求的格式打包将要发送给微信的数据</span>
<span class="hljs-keyword">const</span> wxPcSendCheckData = <span class="hljs-function">(<span class="hljs-params">out_trade_no, appid, mch_id, nonce_str, sign</span>) =&gt;</span> &#123;
    <span class="hljs-comment">// attach 将会在通知支付结果时返回</span>
    <span class="hljs-keyword">return</span> sendData = <span class="hljs-string">'&lt;xml&gt;'</span> +
        <span class="hljs-string">'&lt;appid&gt;'</span> + appid + <span class="hljs-string">'&lt;/appid&gt;'</span> +
        <span class="hljs-string">'&lt;mch_id&gt;'</span> + mch_id + <span class="hljs-string">'&lt;/mch_id&gt;'</span> +
        <span class="hljs-string">'&lt;nonce_str&gt;'</span> + nonce_str + <span class="hljs-string">'&lt;/nonce_str&gt;'</span> +
        <span class="hljs-string">'&lt;out_trade_no&gt;'</span> + out_trade_no + <span class="hljs-string">'&lt;/out_trade_no&gt;'</span> +
        <span class="hljs-string">'&lt;sign&gt;'</span> + sign + <span class="hljs-string">'&lt;/sign&gt;'</span> +
        <span class="hljs-string">'&lt;/xml&gt;'</span>
&#125;

<span class="hljs-comment">// 支付成功之后，我们还需要对交易进行确认，所以根据微信官方文档，调用统一查询接口：</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wx_check</span>(<span class="hljs-params">out_trade_no, key, appid, mch_id, nonce_str</span>) </span>&#123;
    <span class="hljs-keyword">let</span> wxResponse
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">const</span> checkSign = getPcCheckSignForWX(out_trade_no, appid, mch_id, nonce_str)
        <span class="hljs-keyword">const</span> data = wxPcSendCheckData(out_trade_no, appid, mch_id, nonce_str, checkSign)
        wxResponse = <span class="hljs-keyword">await</span> axios.post(<span class="hljs-string">'https://api.mch.weixin.qq.com/pay/orderquery'</span>, data)
        xmlParser.parseString(wxResponse.data, (err, success) =&gt; &#123;
            <span class="hljs-keyword">if</span> (err) &#123;
                <span class="hljs-comment">//</span>
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-keyword">if</span> (success.xml.return_code[<span class="hljs-number">0</span>] === <span class="hljs-string">'SUCCESS'</span>) &#123;
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'pc pay'</span>, success.xml)
                &#125;
            &#125;
        &#125;)
    &#125; <span class="hljs-keyword">catch</span> (e) &#123;

    &#125;
&#125;

<span class="hljs-comment">// 该链接是通过【统一下单API】中提交的参数notify_url设置，如果链接无法访问，商户将无法接收到微信通知。</span>
<span class="hljs-comment">//通知url必须为直接可访问的url，不能携带参数。</span>
<span class="hljs-comment">// 公网域名必须为https，如果是走专线接入，使用专线NAT IP或者私有回调域名可使用http。</span>
<span class="hljs-comment">// 示例：notify_url：“https://pay.weixin.qq.com/wxpay/pay.action”</span>

<span class="hljs-comment">// 支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理，并返回应答</span>
<span class="hljs-comment">// 微信支付的文档请点击这里 ，这里用 js 把它写出来了 https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7</span>
<span class="hljs-comment">// 微信发送的数据是一个 xml ，首先需要吧 xml 转换成 js 的对象</span>
<span class="hljs-comment">// 在 express 中，可以使用 body-parser 这个插件达到效果</span>

<span class="hljs-comment">// 验证签名</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkWXNotifySign</span>(<span class="hljs-params">xmlObj, PAY_API_KEY</span>) </span>&#123;
    <span class="hljs-keyword">let</span> string = <span class="hljs-string">''</span>
    <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">Object</span>.keys(xmlObj)
    keys.sort()
    keys.forEach(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;
        <span class="hljs-keyword">if</span> (xmlObj[key] &amp;&amp; key !== <span class="hljs-string">'sign'</span>) &#123;
            string = string + key + <span class="hljs-string">'='</span> + xmlObj[key] + <span class="hljs-string">'&amp;'</span>
        &#125;
    &#125;)
    string = string + <span class="hljs-string">'key='</span> + PAY_API_KEY
    <span class="hljs-keyword">const</span> localSign = md5(string).toUpperCase()
    <span class="hljs-keyword">return</span> localSign === xmlObj.sign
&#125;


<span class="hljs-keyword">const</span> app = express()

app.all(<span class="hljs-string">"*"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>&#123;
    <span class="hljs-comment">//设置允许跨域的域名，*代表允许任意域名跨域</span>
    res.header(<span class="hljs-string">"Access-Control-Allow-Origin"</span>,<span class="hljs-string">"*"</span>);
    <span class="hljs-comment">//允许的header类型</span>
    res.header(<span class="hljs-string">"Access-Control-Allow-Headers"</span>,<span class="hljs-string">"content-type"</span>);
    <span class="hljs-comment">//跨域允许的请求方式</span>
    res.header(<span class="hljs-string">"Access-Control-Allow-Methods"</span>,<span class="hljs-string">"DELETE,PUT,POST,GET,OPTIONS"</span>);
    <span class="hljs-keyword">if</span> (req.method.toLowerCase() == <span class="hljs-string">'options'</span>)
        res.sendStatus(<span class="hljs-number">200</span>);  <span class="hljs-comment">//让options尝试请求快速结束</span>
    <span class="hljs-keyword">else</span>
        next();
&#125;)

app.use(bodyParser.urlencoded(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>&#125;))
app.use(bodyParser.json())
<span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser-xml'</span>)(bodyParser)
app.use(bodyParser.xml(&#123;
    <span class="hljs-attr">limit</span>: <span class="hljs-string">'1MB'</span>,
    <span class="hljs-attr">xmlParseOptions</span>: &#123;
        <span class="hljs-attr">normalize</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">normalizeTags</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">explicitArray</span>: <span class="hljs-literal">false</span>
    &#125;
&#125;))

app.listen(<span class="hljs-number">3000</span>)
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'listen 3000'</span>)</code></pre>


  
    <div class="post-reward">
    <div id="reward-button">打赏</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
              微信
            </div>
            
        </div>
      </div>
    </div>
  
  <div class="post-guide">
    <div class="item left">
        
          <a href="/2021/12/14/Vue%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC%E4%BC%A0%E9%80%92%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1/">Vue路由跳转传递一个对象</a>
        
    </div>
    <div class="item right">
        
          <a href="/2021/12/10/js%E7%9A%84-%E8%BF%90%E7%AE%97%E7%AC%A6%E8%AF%A6%E8%A7%A3/">js的+运算符详解</a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="https://codermino.github.io">Mino</a>
    </div>
    <div class="link">
      永久链接：<a href="https://codermino.github.io/2021/12/13/vue微信支付/">https://codermino.github.io/2021/12/13/vue微信支付/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="https://codermino.github.io">Mino</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
        <footer>
          <div class="copyright">
            ©2021
            <a href="https://codermino.github.io">Mino</a> Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Mino</a> |
<!--            <a href="https://github.com/shixiaohu2206/hexo-theme-huhu" target="_blank" rel="noopener">hexo-theme-huhu</a>-->
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
